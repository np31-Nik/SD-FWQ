<!DOCTYPE HTML>
<HTML>

<HEAD>

<TITLE>Pagina Inicial</TITLE>
<!---<script type="text/javascript" src="../Registry/API_Registry.js/"></script>--->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<system.webServer>
    <httpProtocol>
      <customHeaders>
        <add name="Access-Control-Allow-Origin" value="*"/>
      </customHeaders>
    </httpProtocol>
<system.webServer>
</HEAD>

<BODY>

<h1>Pagina de Visitantes</h1>
<div id="login">
<form>
<label for="fname">Username:</label>
<input type="text" id="fname" name="fname"><br><br>
<label for="fname">Password:</label>
<input type="text" id="fpass" name="fpass"><br><br>

<h5>Start Ad-Placer!</h5>
<input type="submit" value="Start" onclick="submit()">

<button type="button" onclick="prueba()">Execute</button>
<button type="button" onclick="iniciarSesion()" id="login">Iniciar sesion</button>
<button type="button" onclick="register()" id="Registro">Registrarse</button>

<div id="output">
</div>
</form>
</div>
<div id="parque", style="display:none;">
    <h2>Mapa</h2>
    <div id="mapa">

    </div>
    <h2>Usuarios</h2>
    <div id="usuarios">

    </div>
</div>
<script>
    function myFunction() {
        console.log("Hello from Firefox code");
        alert("xhr.response");
    } 

</script>

<script>
async function prueba(){

    const list = document.createDocumentFragment();

        var output=document.getElementById("output");

        let response = await fetch('http://localhost:3000/usuarios').then((response) => {
      return response.json();
    })
    .then((data) => {
      let authors = data;

      authors.map(function(author) {
        let li = document.createElement('li');
        let name = document.createElement('h2');
        let email = document.createElement('span');

        name.innerHTML = `${author.username}`;
        email.innerHTML = `${author.password}`;

        li.appendChild(name);
        li.appendChild(email);
        list.appendChild(li);
      });
    });
    output.appendChild(list);

    }
    
</script>

<script>
    async function comprobarUsuario(username,password){
        const url = 'http://localhost:3000/login'
        let headers = new Headers();
        let resp = "";
        headers.set('Authorization',btoa(username+":"+password));
        await fetch(url,{method:'GET',headers:headers})
        .then(response => response.text())
        .then(json => {console.log(json); resp=json;});

        if (resp=="200"){
            return true;
        }else{
            return false;
        }
    }
    
    function iniciarSesion(){
        var output=document.getElementById("output");
        var username=document.getElementById('fname').value;
        var password=document.getElementById('fpass').value;
        if(username.length!=0 && password!=0){
            if(!comprobarUsuario(username,password)){
                output.innerHTML="Usuario o contraseÃ±a incorrecta.";
            }else{
                output.innerHTML="Iniciando sesion...";

                var login=document.getElementById("login");
                var parque=document.getElementById("parque");
                login.style.display="none";
                parque.style.display="block";

                iniciado();

            }
        }
        else{
            cad="Debe introducir nombre de usuario y contrasenya";
            output.innerHTML=cad;
        }
    }

    function iniciado(){
        obtenerMapa();
        obtenerUsuarios();
    }

    async function obtenerMapa(){
        const url = 'http://localhost:3003/mapa'
        let headers = new Headers();
        let resp = "";
        var mapa=document.getElementById("mapa");

        //headers.set('Authorization',btoa(username+":"+password));
        await fetch(url,{method:'GET'})
        .then(response => response.text())
        .then(json => {console.log(json); resp=json;});
        mapa.innerHTML=resp;
    }
    async function obtenerUsuarios(){
        const url = 'http://localhost:3003/usuarios'
        let headers = new Headers();
        let resp = "";
        var usuarios=document.getElementById("usuarios");

        //headers.set('Authorization',btoa(username+":"+password));
        await fetch(url,{method:'GET'})
        .then(response => response.text())
        .then(json => {console.log(json); resp=json;});
        usuarios.innerHTML=resp;
    }

</script>

<script>
    function registrar(){ //HACER REQUEST POST!
        var username=document.getElementById('fname').value;
        var password=document.getElementById('fpass').value;
        if(username.length!=0 || password!=0){
            const http=new XMLHttpRequest();
            const url = 'http://localhost:3000/usuarios/';
            http.open("POST",url);
            var data = `{
                "username": "`+username+`",
                "password": `+password+`,
                }`;

            http.send();
            return;
        }
        else{
            cad="Debe introducir nombre de usuario y contrasenya";
            var output=document.getElementById("output");
            output.innerHTML=cad;
        }
    }

</script>

</BODY>

</HTML>